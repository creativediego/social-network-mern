<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding favicon -->
    

    <!-- Adding meta -->
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    


    <title>
      daos/messages/MessageDao.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <div class="navbar-heading" id="navbar-heading"><a href="index.html"><h2 class="navbar-heading-text">Home</h2></a></div><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><div class="accordion collapsed" id="1373502" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="module-BookmarkModel.html">BookmarkModel</a></li><li class="accordion-list" id=""><a href="module-BookmarkSchema.html">BookmarkSchema</a></li><li class="accordion-list" id=""><a href="module-ConversationModel.html">ConversationModel</a></li><li class="accordion-list" id=""><a href="module-ConversationSchema.html">ConversationSchema</a></li><li class="accordion-list" id=""><a href="module-FollowModel.html">FollowModel</a></li><li class="accordion-list" id=""><a href="module-FollowSchema.html">FollowSchema</a></li><li class="accordion-list" id=""><a href="module-LikeModel.html">LikeModel</a></li><li class="accordion-list" id=""><a href="module-LikeSchema.html">LikeSchema</a></li><li class="accordion-list" id=""><a href="module-MessageModel.html">MessageModel</a></li><li class="accordion-list" id=""><a href="module-MessageSchema.html">MessageSchema</a></li><li class="accordion-list" id=""><a href="module-TuitModel.html">TuitModel</a></li><li class="accordion-list" id=""><a href="module-TuitSchema.html">TuitSchema</a></li><li class="accordion-list" id=""><a href="module-UserModel.html">UserModel</a></li><li class="accordion-list" id=""><a href="module-UserSchema.html">UserSchema</a></li></ul> </div><div class="accordion collapsed" id="3522989" > <h3 class="accordion-heading">Classes<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=970619><div class="accordion-heading child"><a href="BookMarkController.html">BookMarkController</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="BookMarkController.html#create">create</a></li><li data-type='method'><a href="BookMarkController.html#delete">delete</a></li><li data-type='method'><a href="BookMarkController.html#findAllByUser">findAllByUser</a></li></ul></li><li class="accordion collapsed child" id=6750298><div class="accordion-heading child"><a href="BookmarkDao.html">BookmarkDao</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="BookmarkDao.html#create">create</a></li><li data-type='method'><a href="BookmarkDao.html#delete">delete</a></li><li data-type='method'><a href="BookmarkDao.html#findAllByUser">findAllByUser</a></li></ul></li><li class="accordion collapsed child" id=4245911><div class="accordion-heading child"><a href="DaoErrorHandler.html">DaoErrorHandler</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="DaoErrorHandler.html#handleError">handleError</a></li><li data-type='method'><a href="DaoErrorHandler.html#handleNull">handleNull</a></li></ul></li><li class="accordion collapsed child" id=8097826><div class="accordion-heading child"><a href="ExpressAdapter.html">ExpressAdapter</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="ExpressAdapter.html#adaptRequest">adaptRequest</a></li><li data-type='method'><a href="ExpressAdapter.html#configAllControllers">configAllControllers</a></li><li data-type='method'><a href="ExpressAdapter.html#handleCentralError">handleCentralError</a></li></ul></li><li class="accordion collapsed child" id=8078042><div class="accordion-heading child"><a href="FollowController.html">FollowController</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="FollowController.html#acceptFollow">acceptFollow</a></li><li data-type='method'><a href="FollowController.html#findAllPendingFollows">findAllPendingFollows</a></li><li data-type='method'><a href="FollowController.html#findAllUsersFollowingUser">findAllUsersFollowingUser</a></li><li data-type='method'><a href="FollowController.html#userFollowsUser">userFollowsUser</a></li><li data-type='method'><a href="FollowController.html#userUnfollowsUser">userUnfollowsUser</a></li></ul></li><li class="accordion collapsed child" id=8337268><div class="accordion-heading child"><a href="FollowDao.html">FollowDao</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="FollowDao.html#acceptFollow">acceptFollow</a></li><li data-type='method'><a href="FollowDao.html#findAllPendingFollows">findAllPendingFollows</a></li><li data-type='method'><a href="FollowDao.html#findAllUsersFollowingUser">findAllUsersFollowingUser</a></li><li data-type='method'><a href="FollowDao.html#findAllUsersThatUserIsFollowing">findAllUsersThatUserIsFollowing</a></li><li data-type='method'><a href="FollowDao.html#userFollowsUser">userFollowsUser</a></li><li data-type='method'><a href="FollowDao.html#userUnfollowsUser">userUnfollowsUser</a></li></ul></li><li class="accordion collapsed child" id=8135963><div class="accordion-heading child"><a href="LikeController.html">LikeController</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="LikeController.html#findAllTuitsLikedByUser">findAllTuitsLikedByUser</a></li><li data-type='method'><a href="LikeController.html#findAllUsersByTuitLike">findAllUsersByTuitLike</a></li><li data-type='method'><a href="LikeController.html#userLikesTuit">userLikesTuit</a></li><li data-type='method'><a href="LikeController.html#userUnlikesTuit">userUnlikesTuit</a></li></ul></li><li class="accordion collapsed child" id=3144630><div class="accordion-heading child"><a href="LikeDao.html">LikeDao</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="LikeDao.html#findAllTuitsLikedByUser">findAllTuitsLikedByUser</a></li><li data-type='method'><a href="LikeDao.html#findAllUsersByTuitLike">findAllUsersByTuitLike</a></li><li data-type='method'><a href="LikeDao.html#userLikesTuit">userLikesTuit</a></li><li data-type='method'><a href="LikeDao.html#userUnlikesTuit">userUnlikesTuit</a></li></ul></li><li class="accordion-list" id=""><a href="Location.html">Location</a></li><li class="accordion collapsed child" id=6950961><div class="accordion-heading child"><a href="MessageController.html">MessageController</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="MessageController.html#createConversation">createConversation</a></li><li data-type='method'><a href="MessageController.html#createMessage">createMessage</a></li><li data-type='method'><a href="MessageController.html#deleteConversation">deleteConversation</a></li><li data-type='method'><a href="MessageController.html#deleteMessage">deleteMessage</a></li><li data-type='method'><a href="MessageController.html#findAllMessagesByConversation">findAllMessagesByConversation</a></li><li data-type='method'><a href="MessageController.html#findLatestMessagesByUser">findLatestMessagesByUser</a></li></ul></li><li class="accordion collapsed child" id=8745216><div class="accordion-heading child"><a href="MessageDao.html">MessageDao</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="MessageDao.html#createConversation">createConversation</a></li><li data-type='method'><a href="MessageDao.html#createMessage">createMessage</a></li><li data-type='method'><a href="MessageDao.html#deleteMessage">deleteMessage</a></li><li data-type='method'><a href="MessageDao.html#findAllMessagesByConversation">findAllMessagesByConversation</a></li><li data-type='method'><a href="MessageDao.html#findLatestMessagesByUser">findLatestMessagesByUser</a></li></ul></li><li class="accordion collapsed child" id=1249056><div class="accordion-heading child"><a href="Server.html">Server</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="Server.html#initControllers">initControllers</a></li><li data-type='method'><a href="Server.html#initDatabase">initDatabase</a></li><li data-type='method'><a href="Server.html#run">run</a></li></ul></li><li class="accordion-list" id=""><a href="Tuit.html">Tuit</a></li><li class="accordion collapsed child" id=7719607><div class="accordion-heading child"><a href="TuitController.html">TuitController</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="TuitController.html#create">create</a></li><li data-type='method'><a href="TuitController.html#delete">delete</a></li><li data-type='method'><a href="TuitController.html#findAll">findAll</a></li><li data-type='method'><a href="TuitController.html#findById">findById</a></li><li data-type='method'><a href="TuitController.html#findByUser">findByUser</a></li><li data-type='method'><a href="TuitController.html#update">update</a></li></ul></li><li class="accordion collapsed child" id=3672621><div class="accordion-heading child"><a href="TuitDao.html">TuitDao</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="TuitDao.html#create">create</a></li><li data-type='method'><a href="TuitDao.html#delete">delete</a></li><li data-type='method'><a href="TuitDao.html#findAll">findAll</a></li><li data-type='method'><a href="TuitDao.html#findById">findById</a></li><li data-type='method'><a href="TuitDao.html#findByUser">findByUser</a></li><li data-type='method'><a href="TuitDao.html#update">update</a></li></ul></li><li class="accordion collapsed child" id=6629326><div class="accordion-heading child"><a href="User.html">User</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="User.html#passwordEquals">passwordEquals</a></li></ul></li><li class="accordion collapsed child" id=981936><div class="accordion-heading child"><a href="UserController.html">UserController</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="UserController.html#create">create</a></li><li data-type='method'><a href="UserController.html#delete">delete</a></li><li data-type='method'><a href="UserController.html#findAll">findAll</a></li><li data-type='method'><a href="UserController.html#findById">findById</a></li><li data-type='method'><a href="UserController.html#update">update</a></li></ul></li><li class="accordion collapsed child" id=2795139><div class="accordion-heading child"><a href="UserDao.html">UserDao</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="UserDao.html#create">create</a></li><li data-type='method'><a href="UserDao.html#delete">delete</a></li><li data-type='method'><a href="UserDao.html#findAll">findAll</a></li><li data-type='method'><a href="UserDao.html#findById">findById</a></li><li data-type='method'><a href="UserDao.html#update">update</a></li></ul></li></ul> </div><div class="accordion collapsed" id="6806025" > <h3 class="accordion-heading">Global<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="global.html#AccountStatus">AccountStatus</a></li><li class="accordion-list" id=""><a href="global.html#AccountType">AccountType</a></li><li class="accordion-list" id=""><a href="global.html#ConversationType">ConversationType</a></li><li class="accordion-list" id=""><a href="global.html#HttpStatusCode">HttpStatusCode</a></li><li class="accordion-list" id=""><a href="global.html#LikeDaoErrors">LikeDaoErrors</a></li><li class="accordion-list" id=""><a href="global.html#MessageDaoErrors">MessageDaoErrors</a></li><li class="accordion-list" id=""><a href="global.html#Methods">Methods</a></li><li class="accordion-list" id=""><a href="global.html#TuitDaoErrors">TuitDaoErrors</a></li><li class="accordion-list" id=""><a href="global.html#UserDaoErrors">UserDaoErrors</a></li></ul> </div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        daos/messages/MessageDao.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this &amp;&amp; this.__importDefault) || function (mod) {
    return (mod &amp;&amp; mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose_1 = __importDefault(require("mongoose"));
const MessageDaoErrors_1 = require("./MessageDaoErrors");
/**
 * DAO database CRUD operations for the messages resources. Implements {@link IMessage}. Takes a {@link MessageModel}, {@link ConversationModel}, and {@link IErrorHandler} as injected dependencies.
 */
class MessageDao {
    /**
     * Constructs the model by setting the dependencies in state: the message model, the conversation model, and the error handle.
     * @param {MessageModel} messageModel the Mongoose message model for db operations
     * @param {ConversationModel} conversationModel the Mongoose conversation model for db operations
     * @param {IErrorHandler} errorHandler the error handler to deal with all exceptions
     */
    constructor(messageModel, conversationModel, errorHandler) {
        /**
         * Create a conversation document by taking an {@link IConversation} object and calling the ConversationModel. In addition to the native _id of the conversation id, also create a conversationId field that is a sorted concatenation of all participant ids. This ensure the conversation document record is unique to avoid duplicating new conversation documents with the same participants.
         * @param conversation the conversation object with all its data
         * @returns the new conversation object after it is created in the ConversationModel
         */
        this.createConversation = (conversation) => __awaiter(this, void 0, void 0, function* () {
            const conversationId = conversation.participants.sort().join('');
            try {
                const convo = yield this.conversationModel.create(Object.assign(Object.assign({}, conversation), { cid: conversationId }));
                return yield convo.populate('createdBy');
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_CREATING_CONVERSATION, err);
            }
        });
        /**
         * Create a new message for an existing conversation by using the existing id of the conversation this message belongs to. Also interact with the ConversationModel to check if sender is a participant in the conversation. If so, then call the MessageModel to create the message.
         * @param {string} sender the send of the message
         * @param {string} message the contents of the message
         * @returns the message document from the MessageModel
         */
        this.createMessage = (sender, message) => __awaiter(this, void 0, void 0, function* () {
            // Check if conversation for this message exists, and if sender is a participant in it.
            try {
                const existingConvo = yield this.conversationModel.exists({
                    _id: message.conversation,
                    participants: { $in: [sender] },
                });
                this.errorHandler.handleNull(existingConvo, MessageDaoErrors_1.MessageDaoErrors.INVALID_CONVERSATION);
                // Create the message.
                const dbMessage = yield this.messageModel.create(Object.assign({ sender }, message));
                return yield dbMessage.populate('sender');
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_CREATING_MESSAGE, err);
            }
        });
        /**
         * Find all messages for conversation for the specified user and conversation ids. Also check if user if indeed a participant in the conversation for security reasons.
         * @param {string} userId the id of the user requesting the messages who should be a participant in the conversation
         * @param {string} conversationId the id of the conversation
         * @returns an array of all {@link IMessage} messages for the conversation.
         */
        this.findAllMessagesByConversation = (userId, conversationId) => __awaiter(this, void 0, void 0, function* () {
            // First, make sure user is a participant in the conversation for which they're trying to get all messages from.
            try {
                const existingConvo = yield this.conversationModel.exists({
                    _id: conversationId,
                    participants: { $in: [userId] },
                });
                this.errorHandler.handleNull(existingConvo, MessageDaoErrors_1.MessageDaoErrors.INVALID_CONVERSATION);
                // Retrieve all the messages for the conversation.
                const allMessagesForConversation = yield this.messageModel.find({
                    conversation: conversationId,
                    removeFor: { $nin: [userId] },
                });
                this.errorHandler.handleNull(allMessagesForConversation, MessageDaoErrors_1.MessageDaoErrors.NO_MATCHING_MESSAGES);
                return allMessagesForConversation;
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_GETTING_CONVERSATION_MESSAGES, err);
            }
        });
        /**
         * Finds the latest messages per conversation for the specified user. This corresponds what the messages inbox is, where the latest messages are by conversation regardless of who sent the last message per conversation. Uses the mongo aggregate functionality to filter and sort through conversations/messages and to format the the returned output.
         * @param {string} uid the id of the user requesting the latest messages
         * @returns an array of {@link IMessage} latest messages per conversation
         */
        this.findLatestMessagesByUser = (uid) => __awaiter(this, void 0, void 0, function* () {
            try {
                const userId = new mongoose_1.default.Types.ObjectId(uid);
                console.log(userId);
                /**
                 * Aggregation piping steps to get latest message per conversation:
                 * 1. Find all conversations where the user is a participant and where the user has not deleted/removed the conversation.
                 * 2. With the found conversations, lookup all the messages that match the conversation id.
                 * 3. Match the messages where the user has not removed/deleted the message.
                 * 4. Do an unwind to split the conversation documents by each message belonging to the conversation. This will help with sorting by message in next step.
                 * 5. Sort each conversation document in descending order by date of message creation.
                 * 6. Group each result into a newly formatted document that only contains the message id, sender, and message content. This helps us get rid of all conversation document meta data we do not need.
                 * 7. Look up the sender to populate the message object with all info of the sender.
                 * 8. Do an unwind to split the documents by sender.
                 */
                const convo = yield this.conversationModel.aggregate([
                    {
                        $match: {
                            participants: {
                                $in: [userId],
                            },
                            removeFrom: {
                                $nin: [userId],
                            },
                        },
                    },
                    {
                        $lookup: {
                            from: 'messages',
                            localField: '_id',
                            foreignField: 'conversation',
                            as: 'messages',
                        },
                    },
                    {
                        $match: {
                            removeFrom: {
                                $nin: [userId],
                            },
                        },
                    },
                    {
                        $unwind: {
                            path: '$messages',
                        },
                    },
                    {
                        $sort: {
                            'messages.createdAt': -1,
                        },
                    },
                    {
                        $group: {
                            _id: '$_id',
                            latestMessage: {
                                $first: '$messages.message',
                            },
                            sender: {
                                $first: '$messages.sender',
                            },
                        },
                    },
                    {
                        $lookup: {
                            from: 'users',
                            localField: 'sender',
                            foreignField: '_id',
                            as: 'sender',
                        },
                    },
                    {
                        $unwind: {
                            path: '$sender',
                        },
                    },
                ]);
                return convo;
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_RETRIEVING_LAST_CONVERSATION_MESSAGES, err);
            }
        });
        this.findAllMessagesSentByUser = (userId) => __awaiter(this, void 0, void 0, function* () {
            try {
                const messages = yield this.messageModel.find({
                    sender: userId,
                });
                return messages;
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_ALL_MESSAGES_SENT_BY_USER, err);
            }
        });
        /**
         * Remove a message for a particular user by finding the message in the database, and placing the user id in the array of removedFor. The message is not technically deleted, and the user is placed in the array of people for whom the message is no longer visible.
         * @param {string} userId the id of the user requesting to delete the message
         * @param {string} messageId the id of the message
         * @returns the deleted message from the Mongoose model once it has updated
         */
        this.deleteMessage = (userId, messageId) => __awaiter(this, void 0, void 0, function* () {
            try {
                const message = yield this.messageModel.findOneAndUpdate({
                    _id: messageId,
                }, {
                    $addToSet: { removeFor: userId }, // only unique entries in the array allowed
                });
                return this.errorHandler.handleNull(message, MessageDaoErrors_1.MessageDaoErrors.NO_MESSAGE_FOUND);
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_DELETING_MESSAGE, err);
            }
        });
        this.deleteConversation = (userId, conversationId) => __awaiter(this, void 0, void 0, function* () {
            try {
                const conversation = yield this.conversationModel.findOneAndUpdate({
                    _id: conversationId,
                }, {
                    $addToSet: { removeFor: userId },
                }, { new: true });
                return this.errorHandler.handleNull(conversation, MessageDaoErrors_1.MessageDaoErrors.NO_CONVERSATION_FOUND);
            }
            catch (err) {
                throw this.errorHandler.handleError(MessageDaoErrors_1.MessageDaoErrors.DB_ERROR_DELETING_CONVERSATION, err);
            }
        });
        this.messageModel = messageModel;
        this.conversationModel = conversationModel;
        this.errorHandler = errorHandler;
        Object.freeze(this); // Make this object immutable.
    }
}
exports.default = MessageDao;
</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"BookmarkModel","link":"<a href=\"module-BookmarkModel.html\">BookmarkModel</a>"},{"title":"BookmarkSchema","link":"<a href=\"module-BookmarkSchema.html\">BookmarkSchema</a>"},{"title":"ConversationModel","link":"<a href=\"module-ConversationModel.html\">ConversationModel</a>"},{"title":"ConversationSchema","link":"<a href=\"module-ConversationSchema.html\">ConversationSchema</a>"},{"title":"FollowModel","link":"<a href=\"module-FollowModel.html\">FollowModel</a>"},{"title":"FollowSchema","link":"<a href=\"module-FollowSchema.html\">FollowSchema</a>"},{"title":"LikeModel","link":"<a href=\"module-LikeModel.html\">LikeModel</a>"},{"title":"LikeSchema","link":"<a href=\"module-LikeSchema.html\">LikeSchema</a>"},{"title":"MessageModel","link":"<a href=\"module-MessageModel.html\">MessageModel</a>"},{"title":"MessageSchema","link":"<a href=\"module-MessageSchema.html\">MessageSchema</a>"},{"title":"TuitModel","link":"<a href=\"module-TuitModel.html\">TuitModel</a>"},{"title":"TuitSchema","link":"<a href=\"module-TuitSchema.html\">TuitSchema</a>"},{"title":"UserModel","link":"<a href=\"module-UserModel.html\">UserModel</a>"},{"title":"UserSchema","link":"<a href=\"module-UserSchema.html\">UserSchema</a>"},{"title":"BookMarkController","link":"<a href=\"BookMarkController.html\">BookMarkController</a>"},{"title":"BookMarkController#create","link":"<a href=\"BookMarkController.html#create\">BookMarkController &rtrif; create</a>"},{"title":"BookMarkController#delete","link":"<a href=\"BookMarkController.html#delete\">BookMarkController &rtrif; delete</a>"},{"title":"BookMarkController#findAllByUser","link":"<a href=\"BookMarkController.html#findAllByUser\">BookMarkController &rtrif; findAllByUser</a>"},{"title":"BookmarkDao","link":"<a href=\"BookmarkDao.html\">BookmarkDao</a>"},{"title":"BookmarkDao#create","link":"<a href=\"BookmarkDao.html#create\">BookmarkDao &rtrif; create</a>"},{"title":"BookmarkDao#delete","link":"<a href=\"BookmarkDao.html#delete\">BookmarkDao &rtrif; delete</a>"},{"title":"BookmarkDao#findAllByUser","link":"<a href=\"BookmarkDao.html#findAllByUser\">BookmarkDao &rtrif; findAllByUser</a>"},{"title":"DaoErrorHandler","link":"<a href=\"DaoErrorHandler.html\">DaoErrorHandler</a>"},{"title":"DaoErrorHandler#handleError","link":"<a href=\"DaoErrorHandler.html#handleError\">DaoErrorHandler &rtrif; handleError</a>"},{"title":"DaoErrorHandler#handleNull","link":"<a href=\"DaoErrorHandler.html#handleNull\">DaoErrorHandler &rtrif; handleNull</a>"},{"title":"ExpressAdapter","link":"<a href=\"ExpressAdapter.html\">ExpressAdapter</a>"},{"title":"ExpressAdapter#adaptRequest","link":"<a href=\"ExpressAdapter.html#adaptRequest\">ExpressAdapter &rtrif; adaptRequest</a>"},{"title":"ExpressAdapter#configAllControllers","link":"<a href=\"ExpressAdapter.html#configAllControllers\">ExpressAdapter &rtrif; configAllControllers</a>"},{"title":"ExpressAdapter#handleCentralError","link":"<a href=\"ExpressAdapter.html#handleCentralError\">ExpressAdapter &rtrif; handleCentralError</a>"},{"title":"FollowController","link":"<a href=\"FollowController.html\">FollowController</a>"},{"title":"FollowController#acceptFollow","link":"<a href=\"FollowController.html#acceptFollow\">FollowController &rtrif; acceptFollow</a>"},{"title":"FollowController#findAllPendingFollows","link":"<a href=\"FollowController.html#findAllPendingFollows\">FollowController &rtrif; findAllPendingFollows</a>"},{"title":"FollowController#findAllUsersFollowingUser","link":"<a href=\"FollowController.html#findAllUsersFollowingUser\">FollowController &rtrif; findAllUsersFollowingUser</a>"},{"title":"FollowController#userFollowsUser","link":"<a href=\"FollowController.html#userFollowsUser\">FollowController &rtrif; userFollowsUser</a>"},{"title":"FollowController#userUnfollowsUser","link":"<a href=\"FollowController.html#userUnfollowsUser\">FollowController &rtrif; userUnfollowsUser</a>"},{"title":"FollowDao","link":"<a href=\"FollowDao.html\">FollowDao</a>"},{"title":"FollowDao#acceptFollow","link":"<a href=\"FollowDao.html#acceptFollow\">FollowDao &rtrif; acceptFollow</a>"},{"title":"FollowDao#findAllPendingFollows","link":"<a href=\"FollowDao.html#findAllPendingFollows\">FollowDao &rtrif; findAllPendingFollows</a>"},{"title":"FollowDao#findAllUsersFollowingUser","link":"<a href=\"FollowDao.html#findAllUsersFollowingUser\">FollowDao &rtrif; findAllUsersFollowingUser</a>"},{"title":"FollowDao#findAllUsersThatUserIsFollowing","link":"<a href=\"FollowDao.html#findAllUsersThatUserIsFollowing\">FollowDao &rtrif; findAllUsersThatUserIsFollowing</a>"},{"title":"FollowDao#userFollowsUser","link":"<a href=\"FollowDao.html#userFollowsUser\">FollowDao &rtrif; userFollowsUser</a>"},{"title":"FollowDao#userUnfollowsUser","link":"<a href=\"FollowDao.html#userUnfollowsUser\">FollowDao &rtrif; userUnfollowsUser</a>"},{"title":"LikeController","link":"<a href=\"LikeController.html\">LikeController</a>"},{"title":"LikeController#findAllTuitsLikedByUser","link":"<a href=\"LikeController.html#findAllTuitsLikedByUser\">LikeController &rtrif; findAllTuitsLikedByUser</a>"},{"title":"LikeController#findAllUsersByTuitLike","link":"<a href=\"LikeController.html#findAllUsersByTuitLike\">LikeController &rtrif; findAllUsersByTuitLike</a>"},{"title":"LikeController#userLikesTuit","link":"<a href=\"LikeController.html#userLikesTuit\">LikeController &rtrif; userLikesTuit</a>"},{"title":"LikeController#userUnlikesTuit","link":"<a href=\"LikeController.html#userUnlikesTuit\">LikeController &rtrif; userUnlikesTuit</a>"},{"title":"LikeDao","link":"<a href=\"LikeDao.html\">LikeDao</a>"},{"title":"LikeDao#findAllTuitsLikedByUser","link":"<a href=\"LikeDao.html#findAllTuitsLikedByUser\">LikeDao &rtrif; findAllTuitsLikedByUser</a>"},{"title":"LikeDao#findAllUsersByTuitLike","link":"<a href=\"LikeDao.html#findAllUsersByTuitLike\">LikeDao &rtrif; findAllUsersByTuitLike</a>"},{"title":"LikeDao#userLikesTuit","link":"<a href=\"LikeDao.html#userLikesTuit\">LikeDao &rtrif; userLikesTuit</a>"},{"title":"LikeDao#userUnlikesTuit","link":"<a href=\"LikeDao.html#userUnlikesTuit\">LikeDao &rtrif; userUnlikesTuit</a>"},{"title":"Location","link":"<a href=\"Location.html\">Location</a>"},{"title":"MessageController","link":"<a href=\"MessageController.html\">MessageController</a>"},{"title":"MessageController#createConversation","link":"<a href=\"MessageController.html#createConversation\">MessageController &rtrif; createConversation</a>"},{"title":"MessageController#createMessage","link":"<a href=\"MessageController.html#createMessage\">MessageController &rtrif; createMessage</a>"},{"title":"MessageController#deleteConversation","link":"<a href=\"MessageController.html#deleteConversation\">MessageController &rtrif; deleteConversation</a>"},{"title":"MessageController#deleteMessage","link":"<a href=\"MessageController.html#deleteMessage\">MessageController &rtrif; deleteMessage</a>"},{"title":"MessageController#findAllMessagesByConversation","link":"<a href=\"MessageController.html#findAllMessagesByConversation\">MessageController &rtrif; findAllMessagesByConversation</a>"},{"title":"MessageController#findLatestMessagesByUser","link":"<a href=\"MessageController.html#findLatestMessagesByUser\">MessageController &rtrif; findLatestMessagesByUser</a>"},{"title":"MessageDao","link":"<a href=\"MessageDao.html\">MessageDao</a>"},{"title":"MessageDao#createConversation","link":"<a href=\"MessageDao.html#createConversation\">MessageDao &rtrif; createConversation</a>"},{"title":"MessageDao#createMessage","link":"<a href=\"MessageDao.html#createMessage\">MessageDao &rtrif; createMessage</a>"},{"title":"MessageDao#deleteMessage","link":"<a href=\"MessageDao.html#deleteMessage\">MessageDao &rtrif; deleteMessage</a>"},{"title":"MessageDao#findAllMessagesByConversation","link":"<a href=\"MessageDao.html#findAllMessagesByConversation\">MessageDao &rtrif; findAllMessagesByConversation</a>"},{"title":"MessageDao#findLatestMessagesByUser","link":"<a href=\"MessageDao.html#findLatestMessagesByUser\">MessageDao &rtrif; findLatestMessagesByUser</a>"},{"title":"Server","link":"<a href=\"Server.html\">Server</a>"},{"title":"Server#initControllers","link":"<a href=\"Server.html#initControllers\">Server &rtrif; initControllers</a>"},{"title":"Server#initDatabase","link":"<a href=\"Server.html#initDatabase\">Server &rtrif; initDatabase</a>"},{"title":"Server#run","link":"<a href=\"Server.html#run\">Server &rtrif; run</a>"},{"title":"Tuit","link":"<a href=\"Tuit.html\">Tuit</a>"},{"title":"TuitController","link":"<a href=\"TuitController.html\">TuitController</a>"},{"title":"TuitController#create","link":"<a href=\"TuitController.html#create\">TuitController &rtrif; create</a>"},{"title":"TuitController#delete","link":"<a href=\"TuitController.html#delete\">TuitController &rtrif; delete</a>"},{"title":"TuitController#findAll","link":"<a href=\"TuitController.html#findAll\">TuitController &rtrif; findAll</a>"},{"title":"TuitController#findById","link":"<a href=\"TuitController.html#findById\">TuitController &rtrif; findById</a>"},{"title":"TuitController#findByUser","link":"<a href=\"TuitController.html#findByUser\">TuitController &rtrif; findByUser</a>"},{"title":"TuitController#update","link":"<a href=\"TuitController.html#update\">TuitController &rtrif; update</a>"},{"title":"TuitDao","link":"<a href=\"TuitDao.html\">TuitDao</a>"},{"title":"TuitDao#create","link":"<a href=\"TuitDao.html#create\">TuitDao &rtrif; create</a>"},{"title":"TuitDao#delete","link":"<a href=\"TuitDao.html#delete\">TuitDao &rtrif; delete</a>"},{"title":"TuitDao#findAll","link":"<a href=\"TuitDao.html#findAll\">TuitDao &rtrif; findAll</a>"},{"title":"TuitDao#findById","link":"<a href=\"TuitDao.html#findById\">TuitDao &rtrif; findById</a>"},{"title":"TuitDao#findByUser","link":"<a href=\"TuitDao.html#findByUser\">TuitDao &rtrif; findByUser</a>"},{"title":"TuitDao#update","link":"<a href=\"TuitDao.html#update\">TuitDao &rtrif; update</a>"},{"title":"User","link":"<a href=\"User.html\">User</a>"},{"title":"User#passwordEquals","link":"<a href=\"User.html#passwordEquals\">User &rtrif; passwordEquals</a>"},{"title":"UserController","link":"<a href=\"UserController.html\">UserController</a>"},{"title":"UserController#create","link":"<a href=\"UserController.html#create\">UserController &rtrif; create</a>"},{"title":"UserController#delete","link":"<a href=\"UserController.html#delete\">UserController &rtrif; delete</a>"},{"title":"UserController#findAll","link":"<a href=\"UserController.html#findAll\">UserController &rtrif; findAll</a>"},{"title":"UserController#findById","link":"<a href=\"UserController.html#findById\">UserController &rtrif; findById</a>"},{"title":"UserController#update","link":"<a href=\"UserController.html#update\">UserController &rtrif; update</a>"},{"title":"UserDao","link":"<a href=\"UserDao.html\">UserDao</a>"},{"title":"UserDao#create","link":"<a href=\"UserDao.html#create\">UserDao &rtrif; create</a>"},{"title":"UserDao#delete","link":"<a href=\"UserDao.html#delete\">UserDao &rtrif; delete</a>"},{"title":"UserDao#findAll","link":"<a href=\"UserDao.html#findAll\">UserDao &rtrif; findAll</a>"},{"title":"UserDao#findById","link":"<a href=\"UserDao.html#findById\">UserDao &rtrif; findById</a>"},{"title":"UserDao#update","link":"<a href=\"UserDao.html#update\">UserDao &rtrif; update</a>"},{"title":"AccountStatus","link":"<a href=\"global.html#AccountStatus\">AccountStatus</a>"},{"title":"AccountType","link":"<a href=\"global.html#AccountType\">AccountType</a>"},{"title":"ConversationType","link":"<a href=\"global.html#ConversationType\">ConversationType</a>"},{"title":"HttpStatusCode","link":"<a href=\"global.html#HttpStatusCode\">HttpStatusCode</a>"},{"title":"LikeDaoErrors","link":"<a href=\"global.html#LikeDaoErrors\">LikeDaoErrors</a>"},{"title":"MessageDaoErrors","link":"<a href=\"global.html#MessageDaoErrors\">MessageDaoErrors</a>"},{"title":"Methods","link":"<a href=\"global.html#Methods\">Methods</a>"},{"title":"TuitDaoErrors","link":"<a href=\"global.html#TuitDaoErrors\">TuitDaoErrors</a>"},{"title":"UserDaoErrors","link":"<a href=\"global.html#UserDaoErrors\">UserDaoErrors</a>"}];
        var options = 
          setupSearch(list, options)
      </script>
    

    

    

    


  </body>

</html>
